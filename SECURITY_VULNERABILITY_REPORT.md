# Security Vulnerability Report: Missing Authentication on User Lookup Endpoint

## Executive Summary

**Severity**: HIGH
**Date**: October 21, 2025
**Discovered By**: API Testing Team
**Issue**: Critical authentication bypass vulnerability allowing unauthorized access to user information

## Vulnerability Description

The `/api/v1/users:lookup` endpoint allows unauthorized access to user profile information without requiring authentication tokens. This enables attackers to enumerate all user accounts in the system by querying different email addresses.

## Discovery Process

### 1. Initial Discovery

During comprehensive API testing, the following test case was executed:

```bash
# Test 3.4: Lookup user without authentication token
curl -s -X GET "http://localhost:8081/api/v1/users:lookup?email=sarah.johnson.biz2025@gmail.com"
```

**Expected Behavior**: HTTP 401 Unauthorized response
**Actual Behavior**: HTTP 200 OK with full user data

```json
{
  "success": true,
  "message": "OK",
  "data": {
    "user_id": 10,
    "name": "Sarah Johnson"
  },
  "total": null
}
```

### 2. Investigation Steps

#### Step 1: Verify Authentication Bypass
- **Test**: Access endpoint without `X-Auth-Token` header
- **Result**: SUCCESS - Full user data returned
- **Implication**: Authentication not enforced

#### Step 2: Test User Enumeration
- **Test**: Query multiple email addresses sequentially
- **Result**: SUCCESS - Existing users found, non-existent users return appropriate errors
- **Implication**: Attackers can enumerate all user accounts

#### Step 3: Code Analysis
**File**: `src/main/java/dev/coms4156/project/groupproject/utils/AuthInterceptor.java`

**Root Cause Identified**: The `preHandle()` method always returns `true`, allowing requests to proceed regardless of authentication status.

```java
// VULNERABLE CODE
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
    throws Exception {
    String token = request.getHeader(RedisKeys.HEADER_TOKEN);
    if (StringUtils.hasText(token)) {
        String json = redis.opsForValue().get(RedisKeys.accessTokenKey(token));
        if (json != null) {
            UserView uv = mapper.readValue(json, UserView.class);
            CurrentUserContext.set(uv);
        }
    }
    return true; // ALWAYS RETURNS TRUE - NO AUTHENTICATION CHECK
}
```

#### Step 4: Configuration Analysis
**File**: `src/main/java/dev/coms4156/project/groupproject/config/WebMvcConfig.java`

- **Intercepted Paths**: `/api/v1/**`
- **Excluded Paths**: Auth endpoints only (`/api/v1/auth/*`)
- **Issue**: `/api/v1/users:lookup` correctly intercepted but not properly validated

## Impact Assessment

### Confidentiality Impact: HIGH
- **User Enumeration**: Attackers can discover all registered email addresses
- **Personal Information**: User names and IDs exposed without authentication
- **Privacy Violation**: Complete breach of user privacy expectations

### Business Impact: HIGH
- **Regulatory Compliance**: Potential GDPR/CCPA violations
- **User Trust**: Complete erosion of user trust in platform security
- **Data Protection**: Failure to implement basic access controls

### Technical Impact: HIGH
- **Authentication Framework**: Fundamental failure of security layer
- **System Design**: Authentication bypass indicates systemic security issues
- **Attack Surface**: All user-facing endpoints potentially vulnerable

## Affected Systems

### Direct Impact
- **Endpoint**: `/api/v1/users:lookup`
- **HTTP Methods**: GET
- **Parameters**: `email` (query parameter)

### Indirect Impact
- All endpoints protected by `AuthInterceptor` potentially vulnerable
- User data across the entire platform at risk

## Proof of Concept

### 1. User Enumeration Attack
```bash
# Enumerate user accounts
for email in "user1@domain.com" "user2@domain.com" "admin@company.com"; do
    response=$(curl -s -X GET "http://localhost:8081/api/v1/users:lookup?email=$email")
    if echo "$response" | jq -e '.success == true'; then
        echo "Found user: $email"
    fi
done
```

### 2. Data Extraction Attack
```bash
# Extract all user data without authentication
curl -s -X GET "http://localhost:8081/api/v1/users:lookup?email=known.user@domain.com" | jq .
```

## Remediation

### Immediate Fix Applied

**File**: `src/main/java/dev/coms4156/project/groupproject/utils/AuthInterceptor.java`

**Changes Made**:
```java
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
    throws Exception {
    String token = request.getHeader(RedisKeys.HEADER_TOKEN);
    if (StringUtils.hasText(token)) {
        String json = redis.opsForValue().get(RedisKeys.accessTokenKey(token));
        if (json != null) {
            UserView uv = mapper.readValue(json, UserView.class);
            CurrentUserContext.set(uv);
            return true;
        }
    }

    // SECURITY FIX: Reject requests without valid authentication
    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
    response.setContentType("application/json");
    response.getWriter().write("{\"success\":false,\"message\":\"AUTH_REQUIRED\",\"data\":null,\"total\":null}");
    return false;
}
```

### Additional Recommendations

1. **Security Testing**: Implement comprehensive security testing in CI/CD pipeline
2. **Code Review**: Mandatory security review for authentication/authorization code
3. **Monitoring**: Add alerts for unusual authentication bypass attempts
4. **Penetration Testing**: Regular security assessments of all endpoints
5. **Security Headers**: Implement additional security headers and CORS policies

## Timeline

- **Discovery**: October 21, 2025 - During API testing automation
- **Analysis**: October 21, 2025 - Root cause investigation completed
- **Fix**: October 21, 2025 - AuthInterceptor patched
- **Testing**: Pending - Requires application restart
- **Deployment**: Pending - Security fix needs deployment

## Verification

### Pre-Fix Behavior
```bash
curl -X GET "http://localhost:8081/api/v1/users:lookup?email=test@example.com"
# Returns: HTTP 200 OK with user data
```

### Expected Post-Fix Behavior
```bash
curl -X GET "http://localhost:8081/api/v1/users:lookup?email=test@example.com"
# Should Return: HTTP 401 Unauthorized
```

### Post-Fix Test (with valid token)
```bash
curl -X GET "http://localhost:8081/api/v1/users:lookup?email=test@example.com" \
  -H "X-Auth-Token: valid_token_here"
# Should Return: HTTP 200 OK with user data
```

## Lessons Learned

1. **Testing Importance**: Comprehensive API testing is crucial for security validation
2. **Authentication Fundamentals**: Security interceptors must actively reject unauthorized requests
3. **Defense in Depth**: Multiple security layers required for robust protection
4. **Security by Default**: All endpoints should require authentication unless explicitly public

## Contact Information

- **Security Team**: API Testing Team
- **Development Team**: Backend Development
- **Date**: October 21, 2025

---

**Status**: FIXED (pending deployment and testing)
**Next Review**: After security fix deployment
**Classification**: HIGH SEVERITY